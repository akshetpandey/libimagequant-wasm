<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>libimagequant WASM PNG Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .panel {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
        }
        
        .image-display {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .image-container {
            max-width: 100%;
            border: 1px solid #ccc;
            margin: 10px 0;
        }
        
        .image-container img {
            max-width: 100%;
            height: auto;
            display: block;
        }
        
        .controls {
            margin: 10px 0;
        }
        
        .controls label {
            display: block;
            margin: 5px 0;
        }
        
        .controls input, .controls select {
            width: 100%;
            margin: 2px 0;
        }
        
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #005a87;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .info {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
        }
        
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
        }
        
        .palette {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(20px, 1fr));
            gap: 2px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .color-swatch {
            width: 20px;
            height: 20px;
            border: 1px solid #000;
            border-radius: 2px;
        }

        .file-drop-area {
            border: 2px dashed #ccc;
            border-radius: 5px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .file-drop-area:hover {
            border-color: #007cba;
        }

        .file-drop-area.drag-over {
            border-color: #007cba;
            background-color: #f0f8ff;
        }

        .download-section {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <h1>libimagequant WASM PNG Test</h1>
    
    <div class="panel">
        <h3>Load PNG Image</h3>
        <div class="file-drop-area" id="fileDropArea">
            <p>Drop a PNG file here or click to select</p>
            <input type="file" id="imageInput" accept="image/png" style="display: none;">
        </div>
        <button onclick="createSamplePng()">Create Sample PNG</button>
    </div>

    <div class="container">
        <div class="panel">
            <h3>Original PNG</h3>
            <div class="image-display">
                <div class="image-container" id="originalImageContainer"></div>
                <div id="originalInfo" class="info"></div>
            </div>
        </div>
        
        <div class="panel">
            <h3>Quantized PNG</h3>
            <div class="image-display">
                <div class="image-container" id="quantizedImageContainer"></div>
                <div id="quantizedInfo" class="info"></div>
            </div>
            
            <h4>Color Palette</h4>
            <div id="palette" class="palette"></div>
        </div>
    </div>

    <div class="panel">
        <h3>Quantization Settings</h3>
        <div class="controls">
            <label>
                Speed (1-10, lower = better quality):
                <input type="range" id="speed" min="1" max="10" value="3">
                <span id="speedValue">3</span>
            </label>
            
            <label>
                Quality Min (0-100):
                <input type="range" id="qualityMin" min="0" max="100" value="70">
                <span id="qualityMinValue">70</span>
            </label>
            
            <label>
                Quality Target (0-100):
                <input type="range" id="qualityTarget" min="0" max="100" value="100">
                <span id="qualityTargetValue">100</span>
            </label>
            
            <label>
                Max Colors (2-256):
                <input type="range" id="maxColors" min="2" max="256" value="256">
                <span id="maxColorsValue">256</span>
            </label>
            
            <label>
                Dithering (0.0-1.0):
                <input type="range" id="dithering" min="0" max="100" value="100">
                <span id="ditheringValue">1.0</span>
            </label>
        </div>
        
        <button id="quantizeBtn" onclick="quantizeImage()" disabled>Quantize PNG</button>
    </div>

    <div id="messages"></div>

    <script type="module">
        import LibImageQuant from '../dist/index.mjs';

        let quantizer = null;
        let originalPngBytes = null;
        let lastResult = null;

        // Initialize quantizer
        async function initQuantizer() {
            try {
                showMessage('Initializing WASM module...', 'info');
                quantizer = new LibImageQuant({
                    workerUrl: '../dist/worker.mjs'
                });
                // Wait for initialization
                await new Promise((resolve, reject) => {
                    setTimeout(async () => {
                        try {
                            // Test if ready by calling a simple method
                            await quantizer.initPromise;
                            resolve();
                        } catch (e) {
                            reject(e);
                        }
                    }, 100);
                });
                showMessage('WASM module initialized successfully!', 'success');
                return true;
            } catch (error) {
                showMessage(`Failed to initialize WASM module: ${error.message}`, 'error');
                return false;
            }
        }

        // Update slider values
        function updateSliderValues() {
            document.getElementById('speedValue').textContent = document.getElementById('speed').value;
            document.getElementById('qualityMinValue').textContent = document.getElementById('qualityMin').value;
            document.getElementById('qualityTargetValue').textContent = document.getElementById('qualityTarget').value;
            document.getElementById('maxColorsValue').textContent = document.getElementById('maxColors').value;
            document.getElementById('ditheringValue').textContent = (document.getElementById('dithering').value / 100).toFixed(2);
        }

        // Add event listeners for sliders
        ['speed', 'qualityMin', 'qualityTarget', 'maxColors', 'dithering'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateSliderValues);
        });

        // File drag and drop handling
        const fileDropArea = document.getElementById('fileDropArea');
        const fileInput = document.getElementById('imageInput');

        fileDropArea.addEventListener('click', () => fileInput.click());
        fileDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDropArea.classList.add('drag-over');
        });
        fileDropArea.addEventListener('dragleave', () => {
            fileDropArea.classList.remove('drag-over');
        });
        fileDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropArea.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                loadPngFromFile(files[0]);
            }
        });

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                loadPngFromFile(file);
            }
        });

        async function loadPngFromFile(file) {
            if (!file.type.startsWith('image/png')) {
                showMessage('Please select a PNG file', 'error');
                return;
            }

            try {
                showMessage('Loading PNG file...', 'info');
                originalPngBytes = new Uint8Array(await file.arrayBuffer());
                
                // Create object URL for display
                const blob = new Blob([originalPngBytes], { type: 'image/png' });
                const url = URL.createObjectURL(blob);
                
                displayImage(url, 'originalImageContainer');
                
                // Update original info
                document.getElementById('originalInfo').innerHTML = `
                    File size: ${formatBytes(originalPngBytes.length)}<br>
                    Type: PNG<br>
                    Status: Loaded
                `;
                
                document.getElementById('quantizeBtn').disabled = false;
                showMessage('PNG loaded successfully!', 'success');
                
            } catch (error) {
                showMessage(`Failed to load PNG: ${error.message}`, 'error');
            }
        }

        window.createSamplePng = async function() {
            try {
                showMessage('Creating sample PNG...', 'info');
                
                // Create a sample image with canvas and convert to PNG
                const canvas = document.createElement('canvas');
                canvas.width = 200;
                canvas.height = 200;
                const ctx = canvas.getContext('2d');
                
                // Create a colorful gradient
                for (let x = 0; x < canvas.width; x++) {
                    for (let y = 0; y < canvas.height; y++) {
                        const r = Math.floor((x / canvas.width) * 255);
                        const g = Math.floor((y / canvas.height) * 255);
                        const b = Math.floor(((x + y) / (canvas.width + canvas.height)) * 255);
                        
                        ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
                        ctx.fillRect(x, y, 1, 1);
                    }
                }
                
                // Convert canvas to PNG bytes
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                originalPngBytes = new Uint8Array(await blob.arrayBuffer());
                
                const url = URL.createObjectURL(blob);
                displayImage(url, 'originalImageContainer');
                
                document.getElementById('originalInfo').innerHTML = `
                    Dimensions: 200 × 200<br>
                    File size: ${formatBytes(originalPngBytes.length)}<br>
                    Type: Sample PNG<br>
                    Status: Generated
                `;
                
                document.getElementById('quantizeBtn').disabled = false;
                showMessage('Sample PNG created successfully!', 'success');
                
            } catch (error) {
                showMessage(`Failed to create sample PNG: ${error.message}`, 'error');
            }
        };

        function displayImage(url, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<img src="${url}" alt="Image">`;
        }

        window.quantizeImage = async function() {
            if (!originalPngBytes || !quantizer) {
                showMessage('Please load a PNG file and wait for WASM initialization', 'error');
                return;
            }

            const btn = document.getElementById('quantizeBtn');
            btn.disabled = true;
            btn.textContent = 'Quantizing...';

            try {
                const options = {
                    speed: parseInt(document.getElementById('speed').value),
                    quality: {
                        min: parseInt(document.getElementById('qualityMin').value),
                        target: parseInt(document.getElementById('qualityTarget').value)
                    },
                    maxColors: parseInt(document.getElementById('maxColors').value),
                    dithering: parseFloat(document.getElementById('dithering').value) / 100
                };

                showMessage('Quantizing PNG...', 'info');
                const startTime = performance.now();
                
                lastResult = await quantizer.quantizePng(originalPngBytes, options);
                
                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);

                // Display quantized PNG
                const quantizedBlob = new Blob([lastResult.pngBytes], { type: 'image/png' });
                const quantizedUrl = URL.createObjectURL(quantizedBlob);
                displayImage(quantizedUrl, 'quantizedImageContainer');
                
                // Display palette
                displayPalette(lastResult.palette);
                
                // Calculate size reduction
                const originalSize = originalPngBytes.length;
                const quantizedSize = lastResult.pngBytes.length;
                const sizeReduction = Math.round((1 - (quantizedSize / originalSize)) * 100);
                
                document.getElementById('quantizedInfo').innerHTML = `
                    Dimensions: ${lastResult.width} × ${lastResult.height}<br>
                    Colors: ${lastResult.paletteLength}<br>
                    Quality: ${Math.round(lastResult.quality * 100)}%<br>
                    PNG size: ${formatBytes(quantizedSize)}<br>
                    Size reduction: ${sizeReduction > 0 ? '+' : ''}${sizeReduction}%<br>
                    Time: ${duration}ms
                `;

                showMessage(`Quantization completed in ${duration}ms with ${lastResult.paletteLength} colors`, 'success');
            } catch (error) {
                showMessage(`Quantization failed: ${error.message}`, 'error');
                console.error('Quantization error:', error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Quantize PNG';
            }
        };

        function displayPalette(palette) {
            const paletteDiv = document.getElementById('palette');
            paletteDiv.innerHTML = '';
            
            palette.forEach((color, index) => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = `rgba(${color[0]}, ${color[1]}, ${color[2]}, ${color[3] / 255})`;
                swatch.title = `Color ${index}: rgba(${color[0]}, ${color[1]}, ${color[2]}, ${color[3]})`;
                paletteDiv.appendChild(swatch);
            });
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            messagesDiv.appendChild(messageDiv);
            
            // Remove message after 5 seconds
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Initialize everything
        updateSliderValues();
        initQuantizer();

        // Make functions available globally
        window.showMessage = showMessage;
    </script>
</body>
</html>